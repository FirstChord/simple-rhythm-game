<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rhythm Game with Pattern Visualizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .controls button {
      font-size: 16px;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #2196F3;
      color: white;
      cursor: pointer;
    }
    
    .controls button:hover {
      background: #1976D2;
    }
    
    .controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    #metronome-container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #tap-area {
      background: white;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #tap-button {
      width: 200px;
      height: 200px;
      font-size: 32px;
      border-radius: 50%;
      border: 3px solid #2196F3;
      background: white;
      cursor: pointer;
      transition: all 0.1s;
    }
    
    #tap-button:active {
      transform: scale(0.95);
      background: #E3F2FD;
    }
    
    #results {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .pattern-display {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>Rhythm Game - Pattern Visualizer Test</h1>
  
  <div class="controls">
    <button id="btn-load-easy">Load Easy Pattern</button>
    <button id="btn-load-complex">Load Complex Pattern</button>
    <button id="btn-load-twobar">Load Two-Bar Pattern</button>
    <button id="btn-start">Start Game</button>
    <button id="btn-stop">Stop</button>
  </div>
  
  <div id="pattern-info" class="pattern-display"></div>
  
  <div id="metronome-container"></div>
  
  <div id="tap-area">
    <button id="tap-button">TAP<br><small>(or SPACE)</small></button>
  </div>
  
  <div id="results" style="display: none;">
    <h3>Results</h3>
    <div id="results-content"></div>
  </div>

  <script src="rhythmEngine.js"></script>
  <script src="visualMetronome.js"></script>
  <script src="patternVisualizer.js"></script>
  <script>
    // Initialize
    const engine = new RhythmEngine(100); // 100 BPM
    const metronome = new VisualMetronome(document.getElementById('metronome-container'));
    const patternVis = new PatternVisualizer(document.getElementById('metronome-container'));
    
    // UI Elements
    const patternInfo = document.getElementById('pattern-info');
    const tapButton = document.getElementById('tap-button');
    const resultsDiv = document.getElementById('results');
    const resultsContent = document.getElementById('results-content');
    
    let currentNoteIndex = 0;
    let updateInterval = null;
    
    // Pattern definitions
    const patterns = {
      easy: [
        { type: 'quarter', rest: false },
        { type: 'quarter', rest: false },
        { type: 'quarter', rest: false },
        { type: 'quarter', rest: false }
      ],
      twoBar: [
        // Bar 1
        { type: 'quarter', rest: false },    // 1 beat
        { type: 'quarter', rest: false },    // 1 beat
        { type: 'eighth', rest: false },     // 0.5 beat
        { type: 'eighth', rest: false },     // 0.5 beat
        { type: 'quarter', rest: false },    // 1 beat
        // Bar 2
        { type: 'quarter', rest: true },     // 1 beat (rest)
        { type: 'quarter', rest: false },    // 1 beat
        { type: 'quarter', rest: false },    // 1 beat
        { type: 'quarter', rest: false }     // 1 beat
        // Total: 8 beats (2 bars)
      ],
      complex: [
        { type: 'quarter', rest: false },    // 1 beat
        { type: 'eighth', rest: false },     // 0.5 beat
        { type: 'eighth', rest: false },     // 0.5 beat
        { type: 'quarter', rest: true },     // 1 beat (rest)
        { type: 'quarter', rest: false }     // 1 beat
        // Total: 4 beats exactly
      ]
    };
    
    // Load pattern
    function loadPattern(patternName) {
      const pattern = patterns[patternName];
      engine.loadPattern(pattern);
      
      // Load into visualizer
      patternVis.loadPattern(pattern, engine.expectedTimes, engine.beatInterval);
      
      // Display pattern info
      patternInfo.innerHTML = `
        <strong>Pattern: ${patternName}</strong><br>
        Notes: ${pattern.map(n => n.rest ? `${n.type}(rest)` : n.type).join(', ')}<br>
        Duration: ${Math.round(engine.expectedTimes[engine.expectedTimes.length - 1] + engine.getNoteDuration(pattern[pattern.length - 1]))}ms
      `;
      
      // Hide the simple note previews since we have the visualizer now
      upcomingNotes.style.display = 'none';
      
      resultsDiv.style.display = 'none';
    }
    
    // Start game
    function startGame() {
      resultsDiv.style.display = 'none';
      currentNoteIndex = 0;
      
      // Start engine and visualizer
      engine.start();
      patternVis.start();
      
      // Check for pattern completion
      updateInterval = setInterval(() => {
        const elapsed = Date.now() - engine.startTime;
        const lastNoteTime = engine.expectedTimes[engine.expectedTimes.length - 1];
        const lastNoteDuration = engine.getNoteDuration(engine.pattern[engine.pattern.length - 1]);
        
        if (elapsed > lastNoteTime + lastNoteDuration + 500) {
          stopGame();
        }
      }, 100);
      
      // Update button states
      document.getElementById('btn-start').disabled = true;
      document.getElementById('btn-stop').disabled = false;
    }
    
    // Stop game
    function stopGame() {
      engine.stop();
      patternVis.stop();
      
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }
      
      // Show results
      showResults();
      
      // Update button states
      document.getElementById('btn-start').disabled = false;
      document.getElementById('btn-stop').disabled = true;
    }
    
    // Show results
    function showResults() {
      const results = engine.scorePattern();
      const stats = engine.getStats(results);
      
      resultsContent.innerHTML = `
        <p><strong>Accuracy:</strong> ${stats.accuracy}%</p>
        <p><strong>Score:</strong> ${stats.score}</p>
        <p><strong>Perfect:</strong> ${stats.perfect}</p>
        <p><strong>Good:</strong> ${stats.good}</p>
        <p><strong>Miss:</strong> ${stats.miss}</p>
        <hr>
        <p><strong>Note by note:</strong></p>
        ${results.map((r, i) => `Note ${i + 1}: ${r.result}`).join('<br>')}
      `;
      
      resultsDiv.style.display = 'block';
    }
    
    // Tap handling
    function handleTapStart() {
      if (engine.isPlaying) {
        engine.registerHoldStart();
        
        // Get immediate feedback
        const elapsed = Date.now() - engine.startTime;
        let closestNote = -1;
        let closestDiff = Infinity;
        
        for (let i = 0; i < engine.expectedTimes.length; i++) {
          if (!engine.pattern[i].rest) {
            const diff = Math.abs(elapsed - engine.expectedTimes[i]);
            if (diff < closestDiff) {
              closestDiff = diff;
              closestNote = i;
            }
          }
        }
        
        if (closestNote >= 0 && closestDiff < engine.scoringWindows.good) {
          const score = engine.scoreNote(closestNote, elapsed);
          patternVis.flashNoteFeedback(closestNote, score.result);
        }
      }
    }
    
    function handleTapEnd() {
      if (engine.isPlaying) {
        engine.registerHoldEnd();
      }
    }
    
    // Event listeners
    document.getElementById('btn-load-easy').addEventListener('click', () => loadPattern('easy'));
    document.getElementById('btn-load-complex').addEventListener('click', () => loadPattern('complex'));
    document.getElementById('btn-load-twobar').addEventListener('click', () => loadPattern('twoBar'));
    document.getElementById('btn-start').addEventListener('click', startGame);
    document.getElementById('btn-stop').addEventListener('click', stopGame);
    
    // Tap button
    tapButton.addEventListener('mousedown', handleTapStart);
    tapButton.addEventListener('mouseup', handleTapEnd);
    tapButton.addEventListener('touchstart', handleTapStart);
    tapButton.addEventListener('touchend', handleTapEnd);
    
    // Keyboard support
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && !e.repeat) {
        e.preventDefault();
        handleTapStart();
        tapButton.classList.add('active');
      }
    });
    
    document.addEventListener('keyup', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        handleTapEnd();
        tapButton.classList.remove('active');
      }
    });
    
    // Initial state
    document.getElementById('btn-stop').disabled = true;
    loadPattern('easy');
  </script>
</body>
</html>